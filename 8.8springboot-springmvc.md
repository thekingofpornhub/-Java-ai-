### 我们先从面试题进行出发

-》以下是根本没有注意到过的面试题

### 限流、熔断、服务降级

### 限流

当系统的处理能力不能应对外部请求的突增流量时，为了不让系统奔溃，必须采取限流的措施。

### 限流指标

#### TPS

系统吞吐量是衡量系统性能的关键指标，按照事务的完成数量来限流是最合理的。

但是对实操性来说，按照事务来限流并不现实。在分布式系统中完成一笔事务需要多个系统的配合。比如我们在电商系统购物，需要订单、库存、账户、支付等多个服务配合完成，有的服务需要异步返回，这样完成一笔事务花费的时间可能会很长。如果按照TPS来进行限流，时间粒度可能会很大大，很难准确评估系统的响应性能。

#### HPS
每秒请求数，指每秒钟服务端收到客户端的请求数量。

如果一个请求完成一笔事务，那TPS和HPS是等同的。但在分布式场景下，完成一笔事务可能需要多次请求，所以TPS和HPS指标不能等同看待。

#### QPS
服务端每秒能够响应的客户端查询请求数量。

如果后台只有一台服务器，那HPS和QPS是等同的。但是在分布式场景下，每个请求需要多个服务器配合完成响应。

目前主流的限流方法多采用HPS作为限流指标。

### 限流方法

### 流量计数器
按照1s多少请求进行划分

优点：简单

缺点：存在单位时间很难把控的问题

有一段时间流量超了，也不一定真的需要限流，如下图，系统HPS限制50，虽然前3s流量超了，但是如果读超时时间设置为5s，并不需要限流。

### 滑动窗口

一个时间滑动窗口中的所有请求的数量的个数不超过一个值，超过了就走降级以及抛弃逻辑

滑动时间窗口的优点是解决了流量计数器算法的缺陷，但是也有2个问题：

流量超过就必须抛弃或者走降级逻辑

对流量控制不够精细，不能限制集中在短时间内的流量，也不能削峰填谷（流量如果多了就降级或者丢弃）

### 漏桶算法

固定容量的桶：漏桶是一个固定容量的缓冲区，用于存储数据。

数据流入：外部数据流以不确定的速率进入漏桶。

漏出速率：漏桶以固定的速率漏水，即以恒定的速率处理数据。

溢出处理：如果漏桶已满，新进入的数据将会被丢弃或延迟处理，以保持漏桶容量的稳定。

### 缺点：

积压请求：漏桶容量过大时，短时间内可以积累大量请求。如果这些请求在短时间内突然释放，会导致服务端瞬间处理大量请求，增加压力。

资源占用：大容量漏桶需要更多的内存和计算资源来维护桶内的状态和请求队列。这会占用服务端的资源，影响其他任务的执行。

延迟增加：漏桶容量过大可能会导致请求在桶内等待的时间过长，增加了请求的延迟，影响用户体验。

突发流量处理：大容量漏桶可能会掩盖突发流量的真实情况，使得服务端无法及时感知和处理突发流量，导致系统在高峰期出现性能问题。

### 令牌桶算法

令牌桶算法就跟病人去医院看病一样，找医生之前需要先挂号，而医院每天放的号是有限的。当天的号用完了，第二天又会放一批号。

只有客户端获取到令牌的时候才能进行访问

令牌桶算法的工作原理

令牌生成：令牌以固定速率生成，并存储在桶中。

请求处理：每个请求需要消耗一个令牌。如果桶中有令牌，请求被处理；否则，请求被拒绝或延迟。

令牌上限：桶的容量是固定的，超过容量的令牌会被丢弃。

### 分布式限流

用redis当令牌桶的存储器（高频访问并且一致性）

## 熔断

### 断路器

断路器有3种状态：

CLOSED：默认状态。断路器观察到请求失败比例没有达到阈值，断路器认为被代理服务状态良好。

OPEN：断路器观察到请求失败比例已经达到阈值，断路器认为被代理服务故障，打开开关，请求不再到达被代理的服务，而是快速失败。

HALF OPEN：断路器打开后，为了能自动恢复对被代理服务的访问，会切换到半开放状态，去尝试请求被代理服务以查看服务是否已经故障恢复。如果成功，会转成CLOSED状态，否则转到OPEN状态。

### 问题

